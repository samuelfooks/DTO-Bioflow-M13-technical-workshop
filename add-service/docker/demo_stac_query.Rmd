---
title: "Demo STAC Endpoint Query"
author: "Sam"
output: html_document
---

```{r setup, include=FALSE}
# Install required packages if not already installed
if (!requireNamespace("rstac", quietly = TRUE)) {
  install.packages("rstac")
}
if (!requireNamespace("sf", quietly = TRUE)) {
  install.packages("sf")
}
if (!requireNamespace("terra", quietly = TRUE)) {
  install.packages("terra")
}
if (!requireNamespace("arrow", quietly = TRUE)) {
  install.packages("arrow")
}

library(rstac)
library(sf)
library(terra)
library(arrow)
```

## Querying the STAC API

This script demonstrates how to query a STAC API and download data.

```{r stac-query-collections}
# Define the root STAC API endpoint
stac_endpoint <- "https://api.dive.edito.eu/data/"

# Query the root STAC API to get collections
collections_query <- stac(stac_endpoint) %>%
  rstac::collections() %>%
  get_request()

# Display the number of collections
cat("Number of collections:", length(collections_query$collections), "\n")
```

```{r stac-query-occurrence}
# Filter collections with 'occurrence' in their name or description directly
occurrence_collections <- Filter(function(collection) {
  grepl("occurrence", collection$title, ignore.case = TRUE)
}, collections_query$collections)

# Display the occurrence collections
print(occurrence_collections)

# Check if any matching collections were found
if (length(occurrence_collections) > 0) {
  occurrence_collection <- occurrence_collections[[1]]$id
  cat("Selected occurrence collection ID:", occurrence_collection, "\n")
} else {
  cat("No collections with 'occurrence' found.\n")
}
```

```{r stac-query-items}
# Query the items in the occurrence collection
if (exists("occurrence_collection")) {
  items_query <- stac(stac_endpoint) %>%
    stac_search(collections = occurrence_collection) %>%
    get_request()

  # Display the items query results
  print(items_query)

  # Extract and display assets from the first item
  if (length(items_query$features) > 0) {
    first_item <- items_query$features[[1]]
    print(first_item$assets)
  } else {
    cat("No items found in the query.\n")
  }
} else {
  cat("Occurrence collection not found.\n")
}
```


# Define a function to open a Parquet dataset from an S3 URL
```{r open-parquet function}

open_my_parquet <- function(s3_url) {
  # Parse the S3 URL to extract the endpoint and path
  temp <- strsplit(s3_url, "//")[[1]][2]  # Remove 'https://'
  endpoint <- strsplit(temp, "/")[[1]][1]  # Extract endpoint
  data_path <- sub(paste0(endpoint, "/"), "", temp)  # Extract path

  # Create the S3FileSystem connection
  data_lake <- S3FileSystem$create(anonymous = TRUE, 
                                   scheme = "https",
                                   endpoint_override = endpoint)

  # Try to open the dataset and handle any errors
  dataset <- NULL
  tryCatch({
    dataset <- arrow::open_dataset(data_path, filesystem = data_lake, format = "parquet")
  }, error = function(e) {
    cat("Error loading dataset:", e$message, "\n")
  })

  # Return the dataset (or NULL if loading failed)
  return(dataset)
}
```


# Extract the first item from the items query
```{r get-parquet}
if (length(items_query$features) > 0) {
  first_item <- items_query$features[[1]]

  # Show all assets in the first item
  print(first_item$assets)

  # Get the Parquet asset
  parquet_asset <- first_item$assets[["parquet"]]$href

  if (!is.null(parquet_asset)) {
    # Open the Parquet asset directly from S3 using the arrow package
    options(timeout = 120)
    parquet_data <- open_my_parquet(parquet_asset)

    if (!is.null(parquet_data)) {
      print(parquet_data$schema)
      print(head(parquet_data))
    } else {
      cat("Failed to load the Parquet dataset.\n")
    }
  } else {
    cat("No Parquet asset found in the first item.\n")
  }
} else {
  cat("No items found in the query.\n")
}
```

# Convert the Parquet dataset to a dataframe and display it
```{r convert-parquet-to-dataframe}
# Convert the Parquet dataset to a dataframe and display the first 100,000 rows
if (!is.null(parquet_data)) {
  parquet_df <- as.data.frame(parquet_data[1:100000, ])

  # Display the first few rows of the dataframe
  print(head(parquet_df))
} else {
  cat("No Parquet dataset available to convert to a dataframe.\n")
}
```